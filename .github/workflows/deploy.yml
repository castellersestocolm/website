name: Deploy

on:
  push:
    branches: [ "master", "dev" ]

env:
  REGISTRY: ghcr.io

jobs:

  build-backend:
    runs-on: ubuntu-latest
    name: Build backend
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build backend
      run: docker build backend --tag ghcr.io/castellersestocolm/backend:${{ github.sha }} --tag ghcr.io/castellersestocolm/backend:${{ github.ref_name }}
    
    - name: Log in to registry
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      
    - name: Push image
      run: docker push ghcr.io/castellersestocolm/backend --all-tags

  build-frontend-org:
    runs-on: ubuntu-latest
    name: Build frontend-org
    
    steps:
    - uses: actions/checkout@v4
    - name: Build frontend-org
      run: docker build frontend-org --tag comunicat/frontend-org:${{ github.sha }} --tag comunicat/frontend-org:${{ github.ref_name }}

  build-frontend-towers:
    runs-on: ubuntu-latest
    name: Build frontend-towers
    
    steps:
    - uses: actions/checkout@v4
    - name: Build frontend-towers
      run: docker build frontend-towers --tag comunicat/frontend-towers:${{ github.sha }} --tag comunicat/frontend-towers:${{ github.ref_name }}
      
  build-pinyator:
    runs-on: ubuntu-latest
    name: Build pinyator
    
    steps:
    - uses: actions/checkout@v4
    - name: Build pinyator
      run: docker build pinyator --tag comunicat/pinyator:${{ github.sha }} --tag comunicat/pinyator:${{ github.ref_name }}
      
  build-php:
    runs-on: ubuntu-latest
    name: Build php
    
    steps:
    - uses: actions/checkout@v4
    - name: Build php
      run: docker build php --tag comunicat/php:${{ github.sha }} --tag comunicat/php:${{ github.ref_name }}
